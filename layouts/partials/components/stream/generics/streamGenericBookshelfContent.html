{{/* streamGenericBookshelfContent.html */}}

{{ $library   := site.GetPage "section" "library" }}
{{ $books     := slice }}
{{ if $library }}
  {{ $books = where $library.Pages "File.BaseFileName" "ne" "masterlist" }}
{{ end }}
{{ $active    := where $books "Params.active" true }}
{{ $reading   := where $books "Params.status" "reading" }}
{{ $activeOnly := where $active "Params.status" "ne" "reading" }}
{{ $activeReading := slice }}
{{ range $reading.ByTitle }}{{ $activeReading = $activeReading | append . }}{{ end }}
{{ range $activeOnly.ByTitle }}{{ $activeReading = $activeReading | append . }}{{ end }}
{{ $activeReading = first 5 $activeReading }}

{{ $finished  := where $books "Params.status" "in" (slice "finished" "complete") }}
{{ $finished  = where $finished "Params.active" "ne" true }}
{{ $finished  = sort $finished "Params.readYear" "desc" }}
{{ $finished  = first 5 $finished }}

{{ $selected  := slice }}
{{ range $activeReading }}{{ $selected = $selected | append . }}{{ end }}
{{ range $finished }}{{ $selected = $selected | append . }}{{ end }}

<div class="SF_SHELF_BLOCK">
  <div class="SF_SHELF_LIST">
    {{ range $selected }}
      {{ $statusRaw := lower (.Params.status | default "") }}
      {{ $statusClass := "" }}
      {{ $statusLabel := "" }}
      {{ if eq $statusRaw "reading" }}
        {{ $statusClass = "reading" }}
        {{ $statusLabel = "Reading" }}
      {{ else if or (eq $statusRaw "finished") (eq $statusRaw "complete") }}
        {{ $statusClass = "finished" }}
        {{ $statusLabel = "Finished" }}
      {{ else if ne $statusRaw "" }}
        {{ $statusClass = $statusRaw }}
        {{ $statusLabel = title $statusRaw }}
      {{ end }}

      {{ $authorVal := "" }}
      {{ with .Params.writer }}
        {{ if reflect.IsSlice . }}
          {{ $authorVal = delimit . ", " }}
        {{ else }}
          {{ $authorVal = . }}
        {{ end }}
      {{ else }}
        {{ with .Params.author }}
          {{ if reflect.IsSlice . }}
            {{ $authorVal = delimit . ", " }}
          {{ else }}
            {{ $authorVal = . }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ $reviewLink := "" }}
      {{ if .Params.reviewRef }}
        {{ $reviewLink = relref . .Params.reviewRef }}
      {{ else if .Params.reviewUrl }}
        {{ $reviewLink = .Params.reviewUrl }}
      {{ end }}

      <div class="SF_SHELF_ENTRY {{ $statusClass }}">
        {{ if $reviewLink }}
          <a class="SF_SHELF_TITLE" href="{{ $reviewLink }}">{{ .Title }}</a>
        {{ else }}
          <span class="SF_SHELF_TITLE">{{ .Title }}</span>
        {{ end }}
        <span class="SF_SHELF_META">
          {{- if $authorVal -}}
            {{ $authorVal }}{{ if $statusLabel }} &mdash; <em>{{ $statusLabel }}</em>{{ end }}
          {{- else if $statusLabel -}}
            <em>{{ $statusLabel }}</em>
          {{- end -}}
        </span>
      </div>
    {{ end }}
  </div>

  <!-- <div class="SF_SHELF_FOOTER">
    <a class="SF_SHELF_VIEWALL" href="/stream/bookshelf">View full shelf →</a>
  </div> -->
</div>
