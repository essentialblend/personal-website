{{/* layouts/partials/sections/librarySection.html */}}

{{ $formats := slice }}
{{ $scopes := slice }}
{{ $years := slice }}
{{ $writers := slice }}
{{ $writerMap := dict }}
{{ $libraryPages := where .Pages "File.BaseFileName" "ne" "masterlist" }}

{{ range $libraryPages }}
  {{ with .Params.format }}
    {{ $formatValue := lower . }}
    {{ if not (in $formats $formatValue) }}
      {{ $formats = $formats | append $formatValue }}
    {{ end }}
  {{ end }}
  {{ with .Params.scope }}
    {{ $scopeValue := lower . }}
    {{ if not (in $scopes $scopeValue) }}
      {{ $scopes = $scopes | append $scopeValue }}
    {{ end }}
  {{ end }}
  {{ $yearValue := "" }}
  {{ with .Params.readYear }}
    {{ $yearValue = printf "%v" . }}
  {{ end }}
  {{ if $yearValue }}
    {{ if not (in $years $yearValue) }}
      {{ $years = $years | append $yearValue }}
    {{ end }}
  {{ end }}

  {{ $writerValues := slice }}
  {{ with .Params.writer }}
    {{ if reflect.IsSlice . }}
      {{ $writerValues = . }}
    {{ else }}
      {{ $writerValues = slice . }}
    {{ end }}
  {{ end }}

  {{ range $writerValues }}
    {{ $writerValue := . }}
    {{ if $writerValue }}
      {{ $writerKey := lower $writerValue }}
      {{ if not (in $writers $writerKey) }}
        {{ $writers = $writers | append $writerKey }}
        {{ $writerMap = merge $writerMap (dict $writerKey $writerValue) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $formats = sort $formats }}
{{ $scopes = sort $scopes }}
{{ $years = sort $years }}
{{ $writers = sort $writers }}

{{ if gt (len $libraryPages) 0 }}
<div class="SF_LIBRARY_FILTER_BAR" data-library-filter data-target-list="library-list-wrapper" data-item-selector=".SF_LIBRARY_ITEM" data-page-size-detail="10">
  <nav aria-label="Filter library entries" class="SF_LIBRARY_FILTER_NAV">
    <div class="SF_LIBRARY_FILTER_LAYOUT">
      {{ if gt (len $formats) 0 }}
      <div class="SF_LIBRARY_FILTER_GROUP SF_LIBRARY_FILTER_GROUP--format" data-filter-group="format">
        <span class="SF_LIBRARY_FILTER_LABEL">Format</span>
        <div class="SF_LIBRARY_FILTER_BUTTONS">
          {{ range $formats }}
          <button type="button" class="SF_TAXONOMYFILTER_BUTTON" data-filter-value="{{ . }}">{{ replace . "-" " " | title }}</button>
          {{ end }}
        </div>
      </div>
      {{ end }}

      {{ if gt (len $years) 0 }}
      <div class="SF_LIBRARY_FILTER_GROUP SF_LIBRARY_FILTER_GROUP--year">
        <span class="SF_LIBRARY_FILTER_LABEL">Year</span>
        <details class="SF_LIBRARY_FILTER_DROPDOWN" data-filter-group="year">
          <summary class="SF_LIBRARY_FILTER_TRIGGER">
            <span class="SF_LIBRARY_FILTER_TRIGGER_TEXT">All years</span>
          </summary>
          <div class="SF_LIBRARY_FILTER_BUTTONS">
            {{ range $years }}
            <button type="button" class="SF_TAXONOMYFILTER_BUTTON" data-filter-value="{{ . }}">{{ . }}</button>
            {{ end }}
          </div>
        </details>
      </div>
      {{ end }}

      {{ if gt (len $scopes) 0 }}
      <div class="SF_LIBRARY_FILTER_GROUP SF_LIBRARY_FILTER_GROUP--scope" data-filter-group="scope">
        <span class="SF_LIBRARY_FILTER_LABEL">Scope</span>
        <div class="SF_LIBRARY_FILTER_BUTTONS">
          {{ range $scopes }}
          <button type="button" class="SF_TAXONOMYFILTER_BUTTON" data-filter-value="{{ . }}">{{ replace . "-" " " | title }}</button>
          {{ end }}
        </div>
      </div>
      {{ end }}

      {{ if gt (len $writers) 0 }}
      <div class="SF_LIBRARY_FILTER_GROUP SF_LIBRARY_FILTER_GROUP--writer">
        <span class="SF_LIBRARY_FILTER_LABEL">Writer</span>
        <details class="SF_LIBRARY_FILTER_DROPDOWN" data-filter-group="writer">
          <summary class="SF_LIBRARY_FILTER_TRIGGER">
            <span class="SF_LIBRARY_FILTER_TRIGGER_TEXT">All writers</span>
          </summary>
          <div class="SF_LIBRARY_FILTER_BUTTONS">
            {{ range $writers }}
            <button type="button" class="SF_TAXONOMYFILTER_BUTTON" data-filter-value="{{ . }}">{{ index $writerMap . }}</button>
            {{ end }}
          </div>
        </details>
      </div>
      {{ end }}

      <div class="SF_LIBRARY_FILTER_GROUP SF_LIBRARY_FILTER_GROUP--sort">
        <span class="SF_LIBRARY_FILTER_LABEL">Sort</span>
        <div class="SF_LIBRARY_FILTER_BUTTONS">
          <button type="button" class="SF_TAXONOMYFILTER_BUTTON SF_LIBRARY_SORT_TOGGLE active" data-sort-key="title" data-sort-direction="asc">Title A-Z</button>
          <button type="button" class="SF_TAXONOMYFILTER_BUTTON SF_LIBRARY_SORT_TOGGLE" data-sort-key="title" data-sort-direction="desc">Title Z-A</button>
          <button type="button" class="SF_TAXONOMYFILTER_BUTTON SF_LIBRARY_SORT_TOGGLE" data-sort-key="writer" data-sort-direction="asc">Writer A-Z</button>
          <button type="button" class="SF_TAXONOMYFILTER_BUTTON SF_LIBRARY_SORT_TOGGLE" data-sort-key="writer" data-sort-direction="desc">Writer Z-A</button>
        </div>
      </div>

      <div class="SF_LIBRARY_FILTER_GROUP SF_LIBRARY_FILTER_GROUP--actions">
        <span class="SF_LIBRARY_FILTER_LABEL">View</span>
        <div class="SF_LIBRARY_FILTER_BUTTONS">
          <button type="button" class="SF_TAXONOMYFILTER_BUTTON SF_LIBRARY_VIEW_TOGGLE active" data-view="detail">Detail</button>
          <button type="button" class="SF_TAXONOMYFILTER_BUTTON SF_LIBRARY_VIEW_TOGGLE" data-view="dense">Dense</button>
          <button type="button" class="SF_TAXONOMYFILTER_CLEAR" title="Clear selected filters">Clear</button>
        </div>
      </div>
    </div>
  </nav>
</div>
{{ end }}

{{ if gt (len $libraryPages) 0 }}
<div class="SF_LIBRARY_WRAPPER" id="library-list-wrapper">
  <div class="notes-list SF_LIBRARY_LIST SF_LIBRARY_LIST--detail">
    {{ range $libraryPages.ByTitle }}
      {{ partial "sections/libraryItem.html" . }}
    {{ end }}
  </div>

  <nav class="SF_PAGINATION SF_LIBRARY_PAGINATION" aria-label="Library pagination" data-library-pagination>
    <button type="button" class="SF_PAGE_LINK SF_PAGE_LINK--nav" data-page-action="prev" aria-label="Previous page">Prev</button>
    <div class="SF_PAGE_NUMBERS" data-page-numbers></div>
    <button type="button" class="SF_PAGE_LINK SF_PAGE_LINK--nav" data-page-action="next" aria-label="Next page">Next</button>
  </nav>

  <div class="notes-list SF_LIBRARY_LIST SF_LIBRARY_LIST--dense">
    {{ range $libraryPages.ByTitle }}
      {{ partial "sections/libraryItem.html" . }}
    {{ end }}
  </div>
</div>
{{ else }}
<p class="SF_LIBRARY_EMPTY">No entries yet.</p>
{{ end }}
